# This folder contains the setup for monitoring the dev systems using Prometheus and Grafana.
### Pre-requisites:
    - Copy outside of "emap" project tree, edit and source grafana-config-envs.EXAMPLE
      . File contains the environment variables for Grafana, edit as needed. When var from that file is undef Grafana will use default first login admin user and password and ask for pw-reset.
### Dev usage, add the following to your docker-compose command as one of -f's:
```bash
... -f emap/emap-monitoring/docker-compose.yml
```
### aside of usual containers under the same "stack" network, the following containers are added:
    - prometheus
    - grafana
    - node-exporter
    - telegraf

### aside of usual volumes, the following volumes are added:
    - prometheus-storage
    - grafana-storage
    - logs: location for telegraf to pick up logs for analysis. Can be mapped by multiple containers to export logs to telegraf.

### Folder structure and file description:
    - grafana:
        - dashboards: contains the json files for the dashboards.
          - 10991_rev14.json: Grafana dashboard for RabbitMQ from rabbitmq website/project.
          - dashboards.yml: Grafana dashboard provisioning configuration file.
          - generated-dashboard.json: generated by create_dashboards.py script. Need to figure how to add this to auto startup with grafana. Script generates ugly dashboard by looking at exported by prometheus metrics.
          - create_dashboards.py: script to generate dashboards from prometheus metrics url.
        - datasources: contains the json files for the datasources.
          - grafana-prometheus-ds.yml: Prometheus datasource configuration file.
    - prometheus/prometheus.yml: Prometheus configuration file.
    - grafana-config-envs.EXAMPLE: Grafana environment variables file.
    - telegraf/telegraf.conf: Telegraf configuration file
    - docker-compose.yml: main file for the monitoring stack.
    - README.md: this file.

### To test debug whole stack without the need to run the whole emap commands, export all required vars as required then run the following or put in script:
```bash
#!/bin/bash
#
docker compose \
  -f emap/core/docker-compose.yml \
  -f emap/core/docker-compose.fakeuds.yml \
  -f emap/hl7-reader/docker-compose.yml \
  -f emap/emap-monitoring/docker-compose.yml \
  -p testemap \
  $( [[ $# -eq 0 ]] && echo "up" || echo "$@" ) 
```

### To access Grafana:
    - Open browser and go to http://localhost:3000
    - Login with the credentials from grafana-config-envs.EXAMPLE
    - Change the password when prompted. if var from grafana-config-envs.EXAMPLE is undef, default first login admin user and password is admin/admin.
    - Enjoy the monitoring!
